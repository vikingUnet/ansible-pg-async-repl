---
# tasks file for postgres_async_replication
- name: Allow network connections
  postgresql_set:
    name: listen_addresses
    value: '*'
  become: yes
  become_user: postgres
  notify: Restart postgres service

- name: Get pg_hba from as query
  postgresql_query:
    query: "show hba_file"
  become: yes
  become_user: postgres
  register: sql_query_pg_hba

- name: Get scalar value for pg_hba path
  set_fact: pg_hba_path="{{ sql_query_pg_hba.query_result[0].hba_file }}"

- debug: var=pg_hba_path

- debug: var="{{  }}"
  loop: "{{ servers_ips }}"

- name: Change pg_pba rules for connect from all hosts
  postgresql_pg_hba:
    dest: "{{ pg_hba_path }}"
    contype: host
    users: all
    source: 0.0.0.0/0
    databases: all
    method: md5
  notify: Restart postgres service

#- name: Change pg_hba rules for replication
#  postgresql_pg_hba:
#    dest: "{{ pg_hba_path }}"
#    contype: host
#    users: replica
#    source: "{{ servers_ips }}"
#    databases: replication
#    method: md5
#  notify: Restart postgres service
